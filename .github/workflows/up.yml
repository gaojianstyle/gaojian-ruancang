# 工作流名称：读取Windows服务器D盘目录
name: 读取Windows服务器D盘目录

# 触发条件：手动触发和main分支推送
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  read-directory:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出代码到GitHub Actions运行器
      - name: 检出代码
        uses: actions/checkout@v3

      # 步骤2：先在Windows服务器创建目标目录（单独用ssh-action，支持script参数）
      - name: 创建D:\scripts目录
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # Windows CMD命令：确保目录存在（用反斜杠\符合Windows格式）
          script: cmd /c "if not exist D:\scripts mkdir D:\scripts"
          debug: true

      # 步骤3：上传scripts文件夹到Windows服务器（移除scp-action中的script参数）
      - name: 上传scripts文件夹到D:\scripts
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "scripts/"  # 上传本地scripts文件夹内的所有内容
          target: "D:\\"  # Windows路径用双反斜杠（YAML转义）
          strip_components: 0  # 保留文件结构
          rm: false
          debug: true

      # 步骤4：执行上传的PowerShell脚本（修正路径，脚本在D:\scripts下）
      - name: 执行PowerShell脚本读取D盘目录
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # 脚本实际路径：上传到了D:\scripts，所以路径是D:\scripts\read_drive_d.ps1
          script: |
            powershell -ExecutionPolicy Bypass -File "D:\scripts\read_drive_d.ps1"
          debug: true