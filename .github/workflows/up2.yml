name: 拉取目标仓库并部署到 Windows 服务器
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  pull-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取目标仓库（gaojian-ruancang）
        uses: actions/checkout@v4
        with:
          repository: gaojianstyle/gaojian-ruancang
          ref: main
          path: ./gaojian-ruancang
          fetch-depth: 0

      - name: 安装 tree 工具
        run: sudo apt-get install -y tree

      - name: 验证仓库拉取结果
        run: |
          echo "目录结构："
          tree ./gaojian-ruancang
          echo "文件总数：$(find ./gaojian-ruancang -type f | wc -l)"
        continue-on-error: true

      - name: 测试与 Windows 服务器的连接（22端口）
        run: |
          HOST_PORT="${{ secrets.WIN_IP }}:22"
          IP=$(echo "$HOST_PORT" | cut -d: -f1)
          PORT=$(echo "$HOST_PORT" | cut -d: -f2)
          echo "测试连接：$IP:$PORT"
          # 使用 ssh-keyscan 测试 SSH 端口连通性
          if ssh-keyscan -p $PORT $IP > /dev/null 2>&1; then
            echo "✅ 服务器 $IP:$PORT 连接成功"
          else
            echo "❌ 服务器 $IP:$PORT 连接失败"
            exit 1
          fi

      - name: 上传文件到 Windows 服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.WIN_IP }}  # 仅填写 IP（如 112.29.65.243，不含端口）
          port: 22  # 单独指定端口
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "./gaojian-ruancang/*"
          target: "d:/codes/gaojian-ruancang"
          debug: true