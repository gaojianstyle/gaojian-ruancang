name: 拉取目标仓库并部署到 Windows 服务器
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  pull-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 安装依赖
        run: sudo apt-get install -y sshpass tree

      - name: 测试服务器连接
        run: |
          HOST="${{ secrets.WIN_IP }}"
          PORT=22
          echo "测试连接：$HOST:$PORT"
          if ssh-keyscan -p "$PORT" "$HOST" > /dev/null 2>&1; then
            echo "✅ 服务器连接成功"
          else
            echo "❌ 服务器连接失败"
            exit 1
          fi

      - name: 通过 SSH 执行部署脚本（直接传递内容）
        run: |
          # 直接通过管道将脚本内容传递给 Windows 的 cmd.exe
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p 22 ${{ secrets.SERVER_USERNAME }}@${{ secrets.WIN_IP }} "cmd /c" << 'EOF'
          @echo off
          setlocal enabledelayedexpansion
          
          rem 定义日志文件（带时间戳）
          set LOG_FILE=d:/.codes/deploy_log_%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%%time:~6,2%.log
          echo "部署日志已保存到：!LOG_FILE!"
          
          rem 执行部署步骤并写入日志
          (
            echo "====== 1. 创建目标目录 ======"
            if not exist "d:/.codes" (
              mkdir "d:/.codes" && echo ✅ 目录创建成功 || (echo ❌ 目录创建失败 && exit 1)
            ) else (
              echo ℹ️ 目录已存在
            )
            
            echo "====== 2. 切换目录并验证 ======"
            cd /d "d:/.codes" || (echo ❌ 切换失败，当前路径：!cd! && exit 1)
            echo ℹ️ 当前目录：!cd!
            echo ------------ 目录内容 ------------
            dir
            echo. > test.txt
            if exist "test.txt" (echo ✅ 测试文件创建成功) else (echo ❌ 测试文件创建失败 && exit 1)
            
            echo "====== 3. 拉取/更新仓库 ======"
            if exist "gaojian-ruancang" (
              echo ℹ️ 仓库已存在，执行更新...
              cd "gaojian-ruancang" && (git status || echo ❌ git status 失败) && git pull origin main || (echo ❌ git pull 失败，错误码：!errorlevel! && exit 1)
            ) else (
              echo ℹ️ 仓库不存在，执行克隆...
              git clone https://gaojianstyle:${{ secrets.GITHUB_PAT }}@github.com/gaojianstyle/gaojian-ruancang.git || (echo ❌ git clone 失败，错误码：!errorlevel! && exit 1)
            )
            
            echo "====== 4. 验证结果 ======"
            if exist "gaojian-ruancang" (
              echo ------------ 仓库结构 ------------
              dir "gaojian-ruancang"
            ) else (
              echo ❌ 仓库不存在，部署失败 && exit 1
            )
            echo ✅ 部署完成！
          ) > !LOG_FILE! 2>&1
          
          rem 输出日志到控制台
          type !LOG_FILE!
          endlocal
          EOF