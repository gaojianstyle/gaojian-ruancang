name: 拉取目标仓库并部署到 Windows 服务器
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  pull-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 安装依赖
        run: sudo apt-get install -y sshpass tree

      - name: 测试服务器连接
        run: |
          HOST="${{ secrets.WIN_IP }}"
          PORT=22
          echo "测试连接：$HOST:$PORT"
          if ssh-keyscan -p "$PORT" "$HOST" > /dev/null 2>&1; then
            echo "✅ 服务器连接成功"
          else
            echo "❌ 服务器连接失败"
            exit 1
          fi

      - name: 执行基础部署命令（简化版）
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p 22 ${{ secrets.SERVER_USERNAME }}@${{ secrets.WIN_IP }} << 'EOF'
          @echo off
          echo "====== 开始执行基础命令 ======"
          
          rem 1. 验证目录是否可访问（使用 C 盘作为备选，避免 D 盘不存在）
          if not exist "c:/codes" (
            mkdir "c:/codes" && echo "✅ 创建 c:/codes 成功" || echo "❌ 创建 c:/codes 失败"
          )
          
          rem 2. 切换到目标目录
          cd /d "c:/codes" && echo "✅ 切换到 c:/codes，当前目录：%cd%" || echo "❌ 切换目录失败"
          
          rem 3. 尝试创建测试文件
          echo. > test.txt && echo "✅ 创建 test.txt 成功" || echo "❌ 创建 test.txt 失败"
          
          rem 4. 验证 Git 是否可用
          git --version || echo "❌ Git 未安装或未加入环境变量"
          
          echo "====== 基础命令执行完毕 ======"
          EOF