name: 读取Windows服务器D盘目录

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  read-directory:
    runs-on: ubuntu-latest

    steps:
      # 步骤1：拉取代码仓库（包含scripts目录下的脚本）
      - name: 拉取代码仓库
        uses: actions/checkout@v4

      # 步骤2：通过SSH将脚本传到Windows服务器，并执行
      - name: 执行D盘目录读取脚本
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # 关键：通过SSH传输本地脚本到Windows临时目录，然后执行
          script: |
            # 将仓库中的scripts/read_drive_d.ps1传到Windows的C:\Temp目录（确保Temp目录存在）
            mkdir -p C:\Temp
            # 从GitHub Runner本地复制脚本到Windows服务器（利用ssh-action的文件传输能力）
            scp ./scripts/read_drive_d.ps1 ${{ secrets.SERVER_USERNAME }}@${{ secrets.WIN_IP }}:C:/Temp/
            # 执行Windows上的PowerShell脚本
            powershell -File C:\Temp\read_drive_d.ps1