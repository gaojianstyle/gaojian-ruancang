name: 拉取目标仓库并部署到 Windows 服务器
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  pull-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 安装依赖
        run: sudo apt-get install -y sshpass tree

      - name: 测试服务器连接
        run: |
          HOST="${{ secrets.WIN_IP }}"
          PORT=22
          echo "测试连接：$HOST:$PORT"
          if ssh-keyscan -p "$PORT" "$HOST" > /dev/null 2>&1; then
            echo "✅ 服务器连接成功"
          else
            echo "❌ 服务器连接失败"
            exit 1
          fi

      - name: 执行基础部署命令（强制使用 D 盘）
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -tt -o StrictHostKeyChecking=no -p 22 ${{ secrets.SERVER_USERNAME }}@${{ secrets.WIN_IP }} << 'EOF'
          @echo off
          echo "====== 开始执行基础命令（强制使用 D 盘）======"
          
          rem 1. 验证 D 盘是否存在
          if exist "d:\" (
            echo "✅ D 盘存在"
          ) else (
            echo "❌ 错误：D 盘不存在，请检查服务器磁盘配置" && exit 1
          )
          
          rem 2. 创建 D 盘目标目录
          if not exist "d:/codes" (
            mkdir "d:/codes" && echo "✅ 创建 d:/codes 成功" || (echo "❌ 创建 d:/codes 失败（可能权限不足）" && exit 1)
          ) else (
            echo "ℹ️ d:/codes 目录已存在"
          )
          
          rem 3. 切换到 D 盘目标目录
          cd /d "d:/codes" && echo "✅ 切换到 d:/codes，当前目录：%cd%" || (echo "❌ 切换到 d:/codes 失败" && exit 1)
          
          rem 4. 验证 D 盘文件操作权限
          echo. > test.txt && echo "✅ 在 d:/codes 创建 test.txt 成功" || (echo "❌ 在 d:/codes 创建文件失败（权限不足）" && exit 1)
          
          rem 5. 验证 Git 是否可用
          git --version || (echo "❌ Git 未安装或未加入环境变量" && exit 1)
          
          echo "====== 基础命令执行完毕（D 盘操作验证通过）======"
          EOF