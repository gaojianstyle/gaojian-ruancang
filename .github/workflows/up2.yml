name: 读取Windows服务器D盘目录

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  read-directory:
    runs-on: ubuntu-latest

    steps:
      - name: 拉取代码仓库
        uses: actions/checkout@v4

      - name: 执行D盘目录读取脚本（D盘操作版）
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            rem 在D盘创建临时目录（避免C盘权限问题）
            if not exist "D:\scripts_temp" mkdir "D:\scripts_temp"
            
            rem 传输脚本到D盘临时目录
            powershell -Command "scp -o StrictHostKeyChecking=no ./scripts/read_drive_d.ps1 ${{ secrets.SERVER_USERNAME }}@${{ secrets.WIN_IP }}:D:/scripts_temp/"
            
            rem 执行D盘上的脚本（显式绕过执行策略）
            powershell -ExecutionPolicy Bypass -File "D:\scripts_temp\read_drive_d.ps1"