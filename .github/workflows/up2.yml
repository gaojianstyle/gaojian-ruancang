name: 读取Windows服务器D盘目录

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  read-directory:
    runs-on: ubuntu-latest

    steps:
      - name: 拉取代码仓库
        uses: actions/checkout@v4

      - name: 执行D盘目录读取脚本
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            rem 确保临时目录存在
            if not exist "C:\Temp" mkdir "C:\Temp"
            
            rem 直接通过SSH动作传输脚本（避免powershell scp的路径问题）
            echo "传输read_drive_d.ps1到Windows服务器"
            rem 使用ssh-action内置的文件传输功能（替代手动scp）
            scp ./scripts/read_drive_d.ps1 C:\Temp\
            
            rem 执行PowerShell脚本并输出结果
            echo "开始执行脚本读取D盘目录"
            powershell -ExecutionPolicy Bypass -File "C:\Temp\read_drive_d.ps1"