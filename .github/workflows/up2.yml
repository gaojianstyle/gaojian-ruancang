name: 读取Windows服务器D盘目录

on:
  workflow_dispatch:
  push:
    branches: [ main ]


jobs:
  read-directory:
    runs-on: ubuntu-latest


    steps:
      - name: 检出代码
        uses: actions/checkout@v3
        
      - name: 上传脚本到远程服务器
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "./scripts/read_drive_d.ps1"
          target: "./scripts/"
          strip_components: 1
          
      - name: 执行PowerShell脚本读取D盘目录
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            # 确保scripts目录存在
            mkdir -p ./scripts
            # 执行PowerShell脚本
            powershell -ExecutionPolicy Bypass -File ./scripts/read_drive_d.ps1