name: 拉取目标仓库并部署到 Windows 服务器
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  pull-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 安装 tree 工具
        run: sudo apt-get install -y tree

      - name: 测试与 Windows 服务器的连接（22端口）
        run: |
          HOST_PORT="${{ secrets.WIN_IP }}:22"
          IP=$(echo "$HOST_PORT" | cut -d: -f1)
          PORT=$(echo "$HOST_PORT" | cut -d: -f2)
          echo "测试连接：$IP:$PORT"
          if ssh-keyscan -p $PORT $IP > /dev/null 2>&1; then
            echo "✅ 服务器 $IP:$PORT 连接成功"
          else
            echo "❌ 服务器 $IP:$PORT 连接失败"
            exit 1
          fi

      - name: 登录 Windows 服务器并拉取仓库
        uses: appleboy/ssh-action@v1.0.3  # 使用 SSH 动作执行命令
        with:
          host: ${{ secrets.WIN_IP }}
          port: 22
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          debug: true
          script: |
            # 进入目标目录，不存在则创建
            if not exist "d:/codes" mkdir "d:/codes"
            cd "d:/codes"
            
            # 若仓库已存在则拉取更新，不存在则克隆
            if exist "gaojian-ruancang" (
              cd "gaojian-ruancang"
              git pull origin main
            ) else (
              git clone https://gaojianstyle:${{ secrets.GITHUB_PAT }}@github.com/gaojianstyle/gaojian-ruancang.git
            )
            
            # 验证拉取结果
            echo "仓库拉取完成，目录结构："
            dir "gaojian-ruancang"