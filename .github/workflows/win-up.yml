# å·¥ä½œæµåç§°ï¼šè¯»å–WindowsæœåŠ¡å™¨Dç›˜ç›®å½•
name: winæœåŠ¡å™¨

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘å’Œmainåˆ†æ”¯æ¨é€
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  win-up:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç åˆ°GitHub Actionsè¿è¡Œå™¨
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      # æ­¥éª¤2ï¼šæ£€æŸ¥æœ¬åœ°scriptsç›®å½•ï¼ˆé¿å…ç©ºç›®å½•ä¸Šä¼ ï¼‰
      - name: æ£€æŸ¥æœ¬åœ°scriptsç›®å½•çŠ¶æ€
        run: |
          echo "ğŸ“‹ æŸ¥çœ‹å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          if [ -d "scripts" ]; then
            echo "âœ… scriptsç›®å½•å­˜åœ¨"
            echo "ğŸ“‹ ç›®å½•å†…å®¹ï¼š"
            ls -la scripts/
            if [ -z "$(ls -A scripts/)" ]; then
              echo "âŒ scriptsç›®å½•ä¸ºç©ºï¼è¯·æ”¾å…¥index.ps1"
              exit 1
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°scriptsç›®å½•ï¼è¯·åˆ›å»ºå¹¶æ”¾å…¥index.ps1"
            exit 1
          fi

      # æ­¥éª¤3ï¼šåœ¨WindowsæœåŠ¡å™¨åˆ›å»ºç›®æ ‡ç›®å½•
      - name: åˆ›å»ºD:\scriptsç›®å½•
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: cmd /c "if not exist D:\scripts mkdir D:\scripts"
          debug: true

      # æ­¥éª¤4ï¼šä¿®å¤SCPä¸Šä¼ ï¼ˆåˆ é™¤é”™è¯¯tar_execï¼Œè·¯å¾„ä¼˜åŒ–ï¼‰
      - name: ä¸Šä¼ scriptsæ–‡ä»¶å¤¹åˆ°WindowsæœåŠ¡å™¨
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "scripts"  # æ‰“åŒ…æ•´ä¸ªscriptsç›®å½•ï¼ˆå«index.ps1ï¼‰
          target: "D:/scripts"  # ä¸Šä¼ åˆ°Windowsçš„D:\scriptsç›®å½•
          strip_components: 0
          rm: false
          debug: true
          # å…³é”®ï¼šåˆ é™¤é”™è¯¯çš„tar_execé…ç½®ï¼Œç”¨é»˜è®¤tarå‘½ä»¤å³å¯

      # æ­¥éª¤5ï¼šæ‰§è¡ŒPowerShellè„šæœ¬ï¼ˆä¿®æ­£è·¯å¾„ï¼Œé¿å…å¤šä¸€å±‚scripts/ï¼‰
      - name: æ‰§è¡Œè„šæœ¬è¯»å–Dç›˜ç›®å½•ï¼ˆä¿å­˜è¾“å‡ºï¼‰
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          debug: true
          script: |
            # æ­£ç¡®è·¯å¾„ï¼šD:\scripts\index.ps1ï¼ˆä¸Šä¼ åç›´æ¥åœ¨scriptsç›®å½•ä¸‹ï¼‰
            powershell -Command "& { . 'D:\scripts\index.ps1' | Out-File -FilePath 'D:\scripts\output.txt' -Encoding utf8; if (Test-Path 'D:\scripts\output.txt') { Write-Host 'âœ… è¾“å‡ºå·²ä¿å­˜åˆ°D:\scripts\output.txt' } else { Write-Host 'âŒ è¾“å‡ºæ–‡ä»¶åˆ›å»ºå¤±è´¥' } }"

      # æ­¥éª¤6ï¼šä¸‹è½½æ‰«æç»“æœæ–‡ä»¶
      - name: ä¸‹è½½Dç›˜æ‰«æç»“æœ
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "D:/scripts/output.txt"
          target: "./"
          direction: download
          debug: true

      # æ­¥éª¤7ï¼šå‘é€åŒ…å«æ‰«æç»“æœçš„é‚®ä»¶
      - name: ç”¨Python+163æˆæƒç å‘é€é‚®ä»¶ï¼ˆå«è¯¦æƒ…ï¼‰
        env:
          SMTP_AUTH_CODE: ${{ secrets.SMTP_AUTH_CODE }}
          EMAIL: ${{ secrets.EMAIL }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        if: success()
        run: |
          python3 - <<EOF
          import smtplib
          import os
          import datetime
          import socket
          from email.mime.text import MIMEText
          from email.header import Header

          smtp_server = "smtp.163.com"
          smtp_port = 465
          sender = os.getenv("EMAIL")
          password = os.getenv("SMTP_AUTH_CODE")
          receiver = os.getenv("TO_EMAIL")

          current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
          hostname = socket.gethostname()

          try:
              with open("./output.txt", "r", encoding="utf-8") as f:
                  scan_result = f.read().strip()
              scan_result = scan_result if scan_result else "âš ï¸ æœªè·å–åˆ°æœ‰æ•ˆç›®å½•æ‰«æç»“æœ"
          except FileNotFoundError:
              scan_result = "âš ï¸ æ‰«æç»“æœæ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼ˆæœªæ‰¾åˆ°output.txtï¼‰"
          except Exception as e:
              scan_result = f"âš ï¸ è¯»å–æ‰«æç»“æœå¤±è´¥ï¼š{str(e)}"

          subject = "ã€GitHub Actionsã€‘WindowsæœåŠ¡å™¨Dç›˜ç›®å½•è¯»å–å®Œæˆï¼ˆå«è¯¦æƒ…ï¼‰"
          body = f"""å°Šæ•¬çš„ç”¨æˆ·ï¼š

          ä»¥ä¸‹æ˜¯GitHub Actionså·¥ä½œæµæ‰§è¡Œè¯¦æƒ…ï¼š
          - æ‰§è¡Œæ—¶é—´ï¼š{current_time}
          - è¿è¡Œç¯å¢ƒï¼š{hostname}
          - ä»»åŠ¡ç±»å‹ï¼šWindowsæœåŠ¡å™¨Dç›˜ç›®å½•æ‰«æ
          - æ‰§è¡Œç»“æœï¼šæˆåŠŸï¼ˆå·²å®Œæ•´è¯»å–Dç›˜ç›®å½•ï¼‰

          ã€Dç›˜ç›®å½•æ‰«æè¯¦ç»†ç»“æœã€‘
          {scan_result}

          æ“ä½œè¯´æ˜ï¼š
          1. å¦‚éœ€éªŒè¯ï¼Œå¯é€šè¿‡SSHç™»å½•WindowsæœåŠ¡å™¨æŸ¥çœ‹Dç›˜æ ¹ç›®å½•
          2. æ‰«æç»“æœæ–‡ä»¶ä¿å­˜åœ¨æœåŠ¡å™¨ D:\scripts\output.txt
          3. æ­¤é‚®ä»¶ä¸ºè‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚"""

          msg = MIMEText(body, "plain", "utf-8")
          msg["From"] = Header(sender, "utf-8")
          msg["To"] = Header(receiver, "utf-8")
          msg["Subject"] = Header(subject, "utf-8")

          try:
              server = smtplib.SMTP_SSL(smtp_server, smtp_port, timeout=10)
              print(f"âœ… è¿æ¥163 SMTPæœåŠ¡å™¨æˆåŠŸ")
              server.login(sender, password)
              print("âœ… æˆæƒç è®¤è¯æˆåŠŸ")
              server.sendmail(sender, receiver, msg.as_string())
              print("âœ… é‚®ä»¶å‘é€æˆåŠŸï¼è¯·æŸ¥æ”¶163é‚®ç®±")
              server.quit()
          except Exception as e:
              print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼š{str(e)}")
              raise
          EOF