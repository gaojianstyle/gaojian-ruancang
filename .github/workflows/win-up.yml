# 工作流名称：读取Windows服务器D盘目录
name: win服务器

# 触发条件：手动触发和main分支推送
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  win-up:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出代码到GitHub Actions运行器
      - name: 检出代码
        uses: actions/checkout@v3

      # 步骤2：先在Windows服务器创建目标目录（单独用ssh-action，支持script参数）
      - name: 创建D:\scripts目录
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # Windows CMD命令：确保目录存在（用反斜杠\符合Windows格式）
          script: cmd /c "if not exist D:\scripts mkdir D:\scripts"
          debug: true

      # 步骤3：上传scripts文件夹到Windows服务器（移除scp-action中的script参数）
      - name: 上传scripts文件夹到D:\scripts
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "scripts/"  # 上传本地scripts文件夹内的所有内容
          target: "D:\\"  # Windows路径用双反斜杠（YAML转义）
          strip_components: 0  # 保留文件结构
          rm: false
          debug: true

      # 步骤4：执行上传的PowerShell脚本（修正路径，脚本在D:\scripts下）
      - name: 执行PowerShell脚本读取D盘目录
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # 脚本实际路径：上传到了D:\scripts，所以路径是D:\scripts\read_drive_d.ps1
          script: |
            powershell -ExecutionPolicy Bypass -File "D:\scripts\index.ps1"
          debug: true
          
      # 步骤5：在Ubuntu环境中配置本地邮件服务器并直接发送邮件
      - name: 部署本地邮件服务器并直接发送通知邮件
        if: success()
        run: |
          # 安装本地邮件服务器和工具
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y postfix mailutils
          
          # 配置Postfix为本地邮件服务器（直接发送模式）
          # 设置主机名为github-actions.local
          sudo hostname github-actions.local
          sudo postconf -e 'myhostname = github-actions.local'
          sudo postconf -e 'mydestination = $myhostname, localhost.localdomain, localhost'
          sudo postconf -e 'mynetworks = 127.0.0.0/8'
          sudo postconf -e 'relayhost = '
          sudo postconf -e 'inet_interfaces = loopback-only'
          
          # 重启Postfix服务
          sudo systemctl restart postfix
          
          # 准备邮件内容
          MAIL_TO="gaojianstyle@163.com"
          MAIL_SUBJECT="Windows服务器D盘目录读取完成"
          MAIL_BODY="GitHub Actions 工作流已成功执行，PowerShell脚本已在Windows服务器上运行完成。"
          
          # 创建临时邮件文件
          echo "Subject: $MAIL_SUBJECT" > /tmp/email.txt
          echo "From: github-actions@github-actions.local" >> /tmp/email.txt
          echo "To: $MAIL_TO" >> /tmp/email.txt
          echo "" >> /tmp/email.txt
          echo "$MAIL_BODY" >> /tmp/email.txt
          
          # 使用sendmail直接发送邮件（不依赖外部SMTP服务器）
          cat /tmp/email.txt | sudo sendmail -t
          
          echo "邮件已通过本地邮件服务器直接发送"