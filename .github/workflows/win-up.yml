# å·¥ä½œæµåç§°ï¼šè¯»å–WindowsæœåŠ¡å™¨Dç›˜ç›®å½•
name: winæœåŠ¡å™¨

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘å’Œmainåˆ†æ”¯æ¨é€
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  win-up:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç åˆ°GitHub Actionsè¿è¡Œå™¨
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      # æ­¥éª¤2ï¼šå¼ºåŒ–æœ¬åœ°æ–‡ä»¶æ£€æŸ¥ï¼ˆç¡®ä¿index.ps1å­˜åœ¨ï¼Œå½»åº•é¿å…ç©ºæ‰“åŒ…ï¼‰
      - name: æ£€æŸ¥æœ¬åœ°scriptsç›®å½•åŠæ–‡ä»¶
        run: |
          echo "ğŸ“‹ æŸ¥çœ‹å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          # æ£€æŸ¥scriptsç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "scripts" ]; then
            echo "âŒ æœªæ‰¾åˆ°scriptsç›®å½•ï¼è¯·åœ¨ä»“åº“æ ¹ç›®å½•åˆ›å»ºscripts/"
            exit 1
          fi
          # æ£€æŸ¥index.ps1æ˜¯å¦å­˜åœ¨ï¼ˆæ ¸å¿ƒæ–‡ä»¶å¿…é¡»æœ‰ï¼‰
          if [ ! -f "scripts/index.ps1" ]; then
            echo "âŒ scriptsç›®å½•ä¸‹æœªæ‰¾åˆ°index.ps1ï¼è¯·æ”¾å…¥æ ¸å¿ƒè„šæœ¬"
            exit 1
          fi
          # åˆ—å‡ºæ–‡ä»¶è¯¦æƒ…ï¼Œç¡®è®¤å­˜åœ¨
          echo "âœ… ç¡®è®¤æ–‡ä»¶å­˜åœ¨ï¼š"
          ls -la scripts/index.ps1
          echo "ğŸ“‹ scriptsç›®å½•å®Œæ•´å†…å®¹ï¼š"
          ls -la scripts/

      # æ­¥éª¤3ï¼šåœ¨WindowsæœåŠ¡å™¨åˆ›å»ºç›®æ ‡ç›®å½•
      - name: åˆ›å»ºD:\scriptsç›®å½•
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: cmd /c "if not exist D:\scripts mkdir D:\scripts"
          debug: true

      # æ­¥éª¤4ï¼šä¿®å¤SCP sourceï¼ˆæ˜ç¡®æ‰“åŒ…ç›®å½•å†…æ‰€æœ‰æ–‡ä»¶ï¼Œé¿å…ç©ºå½’æ¡£ï¼‰
      - name: ä¸Šä¼ scriptsç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶åˆ°WindowsæœåŠ¡å™¨
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "scripts/*"  # å…³é”®ä¿®å¤ï¼šæ˜ç¡®æ‰“åŒ…scriptsç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆè€Œéç›®å½•æœ¬èº«ï¼‰
          target: "D:/scripts"  # ä¸Šä¼ åˆ°Windowsçš„D:\scriptsç›®å½•ï¼ˆæ–‡ä»¶ç›´æ¥åœ¨è¯¥ç›®å½•ä¸‹ï¼‰
          strip_components: 0  # ä¿ç•™æ–‡ä»¶åŸå§‹ç»“æ„ï¼ˆæ— å†—ä½™ç›®å½•ï¼‰
          rm: false
          debug: true

      # æ­¥éª¤5ï¼šæ‰§è¡ŒPowerShellè„šæœ¬ï¼ˆè·¯å¾„æ­£ç¡®ï¼šD:\scripts\index.ps1ï¼‰
      - name: æ‰§è¡Œè„šæœ¬è¯»å–Dç›˜ç›®å½•ï¼ˆä¿å­˜è¾“å‡ºï¼‰
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          debug: true
          script: |
            powershell -Command "& { . 'D:\scripts\index.ps1' | Out-File -FilePath 'D:\scripts\output.txt' -Encoding utf8; if (Test-Path 'D:\scripts\output.txt') { Write-Host 'âœ… è¾“å‡ºå·²ä¿å­˜åˆ°D:\scripts\output.txt' } else { Write-Host 'âŒ è¾“å‡ºæ–‡ä»¶åˆ›å»ºå¤±è´¥' } }"

      # æ­¥éª¤6ï¼šä¸‹è½½æ‰«æç»“æœæ–‡ä»¶
      - name: ä¸‹è½½Dç›˜æ‰«æç»“æœ
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "D:/scripts/output.txt"
          target: "./"
          direction: download
          debug: true

      # æ­¥éª¤7ï¼šå‘é€åŒ…å«æ‰«æç»“æœçš„é‚®ä»¶
      - name: ç”¨Python+163æˆæƒç å‘é€é‚®ä»¶ï¼ˆå«è¯¦æƒ…ï¼‰
        env:
          SMTP_AUTH_CODE: ${{ secrets.SMTP_AUTH_CODE }}
          EMAIL: ${{ secrets.EMAIL }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        if: success()
        run: |
          python3 - <<EOF
          import smtplib
          import os
          import datetime
          import socket
          from email.mime.text import MIMEText
          from email.header import Header

          smtp_server = "smtp.163.com"
          smtp_port = 465
          sender = os.getenv("EMAIL")
          password = os.getenv("SMTP_AUTH_CODE")
          receiver = os.getenv("TO_EMAIL")

          current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
          hostname = socket.gethostname()

          try:
              with open("./output.txt", "r", encoding="utf-8") as f:
                  scan_result = f.read().strip()
              scan_result = scan_result if scan_result else "âš ï¸ æœªè·å–åˆ°æœ‰æ•ˆç›®å½•æ‰«æç»“æœ"
          except FileNotFoundError:
              scan_result = "âš ï¸ æ‰«æç»“æœæ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼ˆæœªæ‰¾åˆ°output.txtï¼‰"
          except Exception as e:
              scan_result = f"âš ï¸ è¯»å–æ‰«æç»“æœå¤±è´¥ï¼š{str(e)}"

          subject = "ã€GitHub Actionsã€‘WindowsæœåŠ¡å™¨Dç›˜ç›®å½•è¯»å–å®Œæˆï¼ˆå«è¯¦æƒ…ï¼‰"
          body = f"""å°Šæ•¬çš„ç”¨æˆ·ï¼š

          ä»¥ä¸‹æ˜¯GitHub Actionså·¥ä½œæµæ‰§è¡Œè¯¦æƒ…ï¼š
          - æ‰§è¡Œæ—¶é—´ï¼š{current_time}
          - è¿è¡Œç¯å¢ƒï¼š{hostname}
          - ä»»åŠ¡ç±»å‹ï¼šWindowsæœåŠ¡å™¨Dç›˜ç›®å½•æ‰«æ
          - æ‰§è¡Œç»“æœï¼šæˆåŠŸï¼ˆå·²å®Œæ•´è¯»å–Dç›˜ç›®å½•ï¼‰

          ã€Dç›˜ç›®å½•æ‰«æè¯¦ç»†ç»“æœã€‘
          {scan_result}

          æ“ä½œè¯´æ˜ï¼š
          1. å¦‚éœ€éªŒè¯ï¼Œå¯é€šè¿‡SSHç™»å½•WindowsæœåŠ¡å™¨æŸ¥çœ‹Dç›˜æ ¹ç›®å½•
          2. æ‰«æç»“æœæ–‡ä»¶ä¿å­˜åœ¨æœåŠ¡å™¨ D:\scripts\output.txt
          3. æ­¤é‚®ä»¶ä¸ºè‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚"""

          msg = MIMEText(body, "plain", "utf-8")
          msg["From"] = Header(sender, "utf-8")
          msg["To"] = Header(receiver, "utf-8")
          msg["Subject"] = Header(subject, "utf-8")

          try:
              server = smtplib.SMTP_SSL(smtp_server, smtp_port, timeout=10)
              print(f"âœ… è¿æ¥163 SMTPæœåŠ¡å™¨æˆåŠŸ")
              server.login(sender, password)
              print("âœ… æˆæƒç è®¤è¯æˆåŠŸ")
              server.sendmail(sender, receiver, msg.as_string())
              print("âœ… é‚®ä»¶å‘é€æˆåŠŸï¼è¯·æŸ¥æ”¶163é‚®ç®±")
              server.quit()
          except Exception as e:
              print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼š{str(e)}")
              raise
          EOF