# 工作流名称：读取Windows服务器D盘目录
name: win服务器

# 触发条件：手动触发和main分支推送
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  win-up:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出代码到GitHub Actions运行器
      - name: 检出代码
        uses: actions/checkout@v3

      # 步骤2：先在Windows服务器创建目标目录（单独用ssh-action，支持script参数）
      - name: 创建D:\scripts目录
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # Windows CMD命令：确保目录存在（用反斜杠\符合Windows格式）
          script: cmd /c "if not exist D:\scripts mkdir D:\scripts"
          debug: true

      # 步骤3：上传scripts文件夹到Windows服务器（移除scp-action中的script参数）
      - name: 上传scripts文件夹到D:\scripts
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "scripts/"  # 上传本地scripts文件夹内的所有内容
          target: "D:\\"  # Windows路径用双反斜杠（YAML转义）
          strip_components: 0  # 保留文件结构
          rm: false
          debug: true

      # 步骤4：执行上传的PowerShell脚本（修正路径，脚本在D:\scripts下）
      - name: 执行PowerShell脚本读取D盘目录
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # 脚本实际路径：上传到了D:\scripts，所以路径是D:\scripts\read_drive_d.ps1
          script: |
            powershell -ExecutionPolicy Bypass -File "D:\scripts\index.ps1"
          debug: true
      
      # 第五步：用163 SMTP发送通知邮件（核心代码，添加到现有steps末尾）
      - name: 用Python+163授权码直连发送邮件（最终版）
        if: success()
        run: |
          # 无需额外安装依赖（GitHub Runner默认带Python3和smtplib）
          python3 - <<EOF
          import smtplib
          import os
          from email.mime.text import MIMEText
          from email.header import Header

          # 1. 配置信息（从GitHub Secrets读取，安全无泄露）
          smtp_server = "smtp.163.com"
          smtp_port = 465  # 163 SSL固定端口（必用，兼容性最好）
          sender = os.getenv("EMAIL")  # 发件人（必须和授权码对应） 
          password = os.getenv("SMTP_AUTH_CODE")  # 读取Secrets中的授权码
          receiver = "gaojianstyle@163.com"  # 收件人

          # 2. 构造邮件内容
          subject = "【GitHub Actions】Windows服务器D盘目录读取完成"
          body = """尊敬的用户： 
          以下是GitHub Actions工作流执行详情：
          - 执行时间：$(date +"%Y-%m-%d %H:%M:%S")
          - 运行环境：$(hostname)
          - 任务类型：Windows服务器D盘目录扫描
          - 执行结果：成功（已完整读取D盘所有目录/文件）
          - 操作说明：如需查看详细目录列表，可通过SSH登录Windows服务器查看D盘根目录
          此邮件由GitHub Actions自动发送，请勿回复。"""

          # 3. 邮件格式处理
          msg = MIMEText(body, "plain", "utf-8")
          msg["From"] = Header(sender, "utf-8")  # 发件人名称
          msg["To"] = Header(receiver, "utf-8")  # 收件人名称
          msg["Subject"] = Header(subject, "utf-8")  # 邮件主题

          try:
              # 4. 直连163 SMTP服务器（SSL加密）
              server = smtplib.SMTP_SSL(smtp_server, smtp_port, timeout=10)
              # 打印连接日志（方便排查）
              print(f"✅ 成功连接163 SMTP服务器（{smtp_server}:{smtp_port}）")
              
              # 5. 授权码认证
              server.login(sender, password)
              print("✅ 授权码认证成功")
              
              # 6. 发送邮件
              server.sendmail(sender, receiver, msg.as_string())
              print("✅ 邮件发送成功！请查收163邮箱")
              
              # 7. 关闭连接
              server.quit()
          except Exception as e:
              # 打印错误日志（关键排查信息）
              print(f"❌ 邮件发送失败：{str(e)}")
              raise  # 抛出错误，让工作流显示失败（方便排查）
          EOF
        env:
          # 把GitHub Secrets中的授权码传入环境变量（Python读取）
          SMTP_AUTH_CODE: ${{ secrets.SMTP_AUTH_CODE }}