# å·¥ä½œæµåç§°ï¼šè¯»å–WindowsæœåŠ¡å™¨Dç›˜ç›®å½•
name: winæœåŠ¡å™¨

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘å’Œmainåˆ†æ”¯æ¨é€
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  win-up:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç åˆ°GitHub Actionsè¿è¡Œå™¨
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      # æ­¥éª¤2ï¼šå…ˆåœ¨WindowsæœåŠ¡å™¨åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆå•ç‹¬ç”¨ssh-actionï¼Œæ”¯æŒscriptå‚æ•°ï¼‰
      - name: åˆ›å»ºD:\scriptsç›®å½•
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # Windows CMDå‘½ä»¤ï¼šç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆç”¨åæ–œæ \ç¬¦åˆWindowsæ ¼å¼ï¼‰
          script: cmd /c "if not exist D:\scripts mkdir D:\scripts"
          debug: true

      # æ­¥éª¤3ï¼šä¸Šä¼ scriptsæ–‡ä»¶å¤¹åˆ°WindowsæœåŠ¡å™¨ï¼ˆç§»é™¤scp-actionä¸­çš„scriptå‚æ•°ï¼‰
      - name: ä¸Šä¼ scriptsæ–‡ä»¶å¤¹åˆ°D:\scripts
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "scripts/"  # ä¸Šä¼ æœ¬åœ°scriptsæ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰å†…å®¹
          target: "D:\\"  # Windowsè·¯å¾„ç”¨åŒåæ–œæ ï¼ˆYAMLè½¬ä¹‰ï¼‰
          strip_components: 0  # ä¿ç•™æ–‡ä»¶ç»“æ„
          rm: false
          debug: true

      # æ­¥éª¤4ï¼šæ‰§è¡Œä¸Šä¼ çš„PowerShellè„šæœ¬ï¼ˆä¿®æ­£è·¯å¾„ï¼Œè„šæœ¬åœ¨D:\scriptsä¸‹ï¼‰
      - name: æ‰§è¡ŒPowerShellè„šæœ¬è¯»å–Dç›˜ç›®å½•
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # è„šæœ¬å®é™…è·¯å¾„ï¼šä¸Šä¼ åˆ°äº†D:\scriptsï¼Œæ‰€ä»¥è·¯å¾„æ˜¯D:\scripts\read_drive_d.ps1
          script: |
            powershell -ExecutionPolicy Bypass -File "D:\scripts\index.ps1"
          debug: true
      
      # ç¬¬äº”æ­¥ï¼šç”¨163 SMTPå‘é€é€šçŸ¥é‚®ä»¶ï¼ˆæ ¸å¿ƒä»£ç ï¼Œæ·»åŠ åˆ°ç°æœ‰stepsæœ«å°¾ï¼‰
      - name: ä¿®å¤163 SMTPå‘é€ï¼ˆæ¢ç«¯å£+å¼ºåˆ¶æŠ•é€’ï¼‰
        if: success()
        run: |
          # 1. å®‰è£…ä¾èµ–ï¼ˆä¿æŒä¸å˜ï¼‰
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y postfix mailutils libsasl2-modules
          
          # 2. å…³é”®ä¿®å¤ï¼šæ¢163 SSLç«¯å£465ï¼Œé€‚é…Runnerç¯å¢ƒ
          sudo hostname github-actions-runner
          sudo postconf -e 'myhostname = github-actions-runner'
          sudo postconf -e 'mydestination = $myhostname, localhost'
          sudo postconf -e 'mynetworks = 127.0.0.0/8'
          sudo postconf -e 'inet_interfaces = loopback-only'
          sudo postconf -e 'myorigin = github-actions-runner'
          sudo postconf -e 'inet_protocols = ipv4'
          
          # ä¿®å¤1ï¼šç”¨163 SSLç«¯å£465ï¼ˆæ›¿ä»£587ï¼Œå…¼å®¹æ€§æ›´å¥½ï¼‰
          sudo postconf -e 'relayhost = [smtp.163.com]:465'
          # ä¿®å¤2ï¼šå¯ç”¨smtpsåè®®ï¼ˆé€‚é…465ç«¯å£çš„SSLåŠ å¯†ï¼‰
          sudo postconf -e 'smtp_use_tls = yes'
          sudo postconf -e 'smtp_tls_security_level = ssl'
          sudo postconf -e 'smtp_tls_protocols = TLSv1.2 TLSv1.3'
          sudo postconf -e 'smtp_tls_ciphers = high'
          # ä¿®å¤3ï¼šSMTPè®¤è¯é…ç½®ï¼ˆä¿æŒä¸å˜ï¼‰
          sudo postconf -e 'smtp_sasl_auth_enable = yes'
          sudo postconf -e 'smtp_sasl_security_options = noanonymous'
          sudo postconf -e 'smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd'
          
          # 3. é…ç½®163è´¦å·ï¼ˆä¿æŒä¸å˜ï¼‰
          echo '[smtp.163.com]:465 gaojianstyle@163.com:${{ secrets.SMTP_AUTH_CODE }}' | sudo tee /etc/postfix/sasl_passwd
          sudo postmap /etc/postfix/sasl_passwd
          sudo chmod 600 /etc/postfix/sasl_passwd
          sudo chmod 600 /etc/postfix/sasl_passwd.db
          
          # 4. é‡å¯Postfixå¹¶å¼ºåˆ¶é‡æ–°åŠ è½½é…ç½®
          sudo systemctl restart postfix
          sudo postfix reload  # å¼ºåˆ¶åŠ è½½æ–°é…ç½®
          sudo systemctl status postfix --no-pager
          
          # 5. å‡†å¤‡é‚®ä»¶å†…å®¹ï¼ˆä¿æŒä¸å˜ï¼‰
          MAIL_TO="gaojianstyle@163.com"
          MAIL_SUBJECT="ã€GitHub Actionsã€‘WindowsæœåŠ¡å™¨Dç›˜ç›®å½•è¯»å–å®Œæˆ"
          MAIL_BODY=$(cat <<EOF
          å°Šæ•¬çš„ç”¨æˆ·ï¼š
          
          ä»¥ä¸‹æ˜¯GitHub Actionså·¥ä½œæµæ‰§è¡Œè¯¦æƒ…ï¼š
          - æ‰§è¡Œæ—¶é—´ï¼š$(date +"%Y-%m-%d %H:%M:%S")
          - è¿è¡Œç¯å¢ƒï¼š$(hostname)
          - ä»»åŠ¡ç±»å‹ï¼šWindowsæœåŠ¡å™¨Dç›˜ç›®å½•æ‰«æ
          - æ‰§è¡Œç»“æœï¼šæˆåŠŸï¼ˆå·²å®Œæ•´è¯»å–Dç›˜æ‰€æœ‰ç›®å½•/æ–‡ä»¶ï¼‰
          - æ“ä½œè¯´æ˜ï¼šå¦‚éœ€æŸ¥çœ‹è¯¦ç»†ç›®å½•åˆ—è¡¨ï¼Œå¯é€šè¿‡SSHç™»å½•WindowsæœåŠ¡å™¨æŸ¥çœ‹Dç›˜æ ¹ç›®å½•
          
          æ­¤é‚®ä»¶ç”±GitHub Actionsè‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚
          EOF
          )
          
          # 6. å‘é€é‚®ä»¶+å¼ºåˆ¶æŠ•é€’é˜Ÿåˆ—ï¼ˆå…³é”®ï¼šç«‹å³å‘é€ï¼Œä¸å»¶è¿Ÿï¼‰
          echo "$MAIL_BODY" | mail -s "$MAIL_SUBJECT" -r "gaojianstyle@163.com" "$MAIL_TO" && echo "âœ… é‚®ä»¶å·²æäº¤åˆ°å‘é€é˜Ÿåˆ—" || echo "âŒ é‚®ä»¶æäº¤å¤±è´¥"
          sudo postfix flush  # å¼ºåˆ¶æŠ•é€’æ‰€æœ‰é˜Ÿåˆ—ä¸­çš„é‚®ä»¶
          echo "âœ… å·²å¼ºåˆ¶è§¦å‘é‚®ä»¶æŠ•é€’"
          
          # 7. è¾“å‡ºè¯¦ç»†é€šä¿¡æ—¥å¿—ï¼ˆé‡ç‚¹çœ‹163æœåŠ¡å™¨å“åº”ï¼‰
          echo -e "\nğŸ“‹ 163 SMTPé€šä¿¡æ—¥å¿—ï¼ˆæœ€å100è¡Œï¼‰ï¼š"
          sudo tail -n 100 /var/log/mail.log
          echo -e "\nğŸ“‹ é˜Ÿåˆ—çŠ¶æ€ï¼š"
          sudo postqueue -p