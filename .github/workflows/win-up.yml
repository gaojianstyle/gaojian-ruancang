# 工作流名称：读取Windows服务器D盘目录
name: win服务器

# 触发条件：手动触发和main分支推送
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  win-up:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出代码到GitHub Actions运行器
      - name: 检出代码
        uses: actions/checkout@v3

      # 步骤2：先在Windows服务器创建目标目录（单独用ssh-action，支持script参数）
      - name: 创建D:\scripts目录
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # Windows CMD命令：确保目录存在（用反斜杠\符合Windows格式）
          script: cmd /c "if not exist D:\scripts mkdir D:\scripts"
          debug: true

      # 步骤3：上传scripts文件夹到Windows服务器（移除scp-action中的script参数）
      - name: 上传scripts文件夹到D:\scripts
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "scripts/"  # 上传本地scripts文件夹内的所有内容
          target: "D:\\"  # Windows路径用双反斜杠（YAML转义）
          strip_components: 0  # 保留文件结构
          rm: false
          debug: true

      # 步骤4：执行上传的PowerShell脚本（修正路径，脚本在D:\scripts下）
      - name: 执行PowerShell脚本读取D盘目录
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # 脚本实际路径：上传到了D:\scripts，所以路径是D:\scripts\read_drive_d.ps1
          script: |
            powershell -ExecutionPolicy Bypass -File "D:\scripts\index.ps1"
          debug: true
      
      - name: 部署本地邮件服务器并发送通知邮件
        if: success()
        run: |
          # 安装依赖（确保组件完整）
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y postfix mailutils libsasl2-modules
          
          # 核心配置优化（适配公共邮箱接收规则）
          sudo hostname github-actions-runner  # 使用更规范的主机名
          sudo postconf -e 'myhostname = github-actions-runner'  # 避免.local等非公共域名
          sudo postconf -e 'mydestination = $myhostname, localhost'  # 精简本地目标域
          sudo postconf -e 'mynetworks = 127.0.0.0/8'  # 仅允许本地发送
          sudo postconf -e 'relayhost ='  # 不使用中继（不依赖第三方）
          sudo postconf -e 'inet_interfaces = loopback-only'  # 仅监听本地接口（安全）
          sudo postconf -e 'myorigin = $myhostname'  # 发件人域名与主机名一致
          sudo postconf -e 'inet_protocols = ipv4'  # 避免IPv6可能的兼容问题
          sudo postconf -e 'smtp_tls_security_level = may'  # 允许TLS加密传输（提高可信度）
          sudo postconf -e 'smtp_header_checks = regexp:/etc/postfix/header_checks'  # 清理可能被标记的头信息
          
          # 清理敏感头信息（避免被识别为垃圾邮件）
          echo '!/^From:/ REPLACE From: GitHub Actions <action@github-actions-runner>' | sudo tee /etc/postfix/header_checks
          sudo postmap /etc/postfix/header_checks  # 生效头信息规则
          
          # 重启服务并验证状态
          sudo systemctl restart postfix
          sudo systemctl status postfix --no-pager  # 输出状态便于调试
          
          # 准备邮件内容（规范格式）
          MAIL_TO="gaojianstyle@163.com"
          MAIL_SUBJECT="Windows服务器D盘目录读取完成"
          MAIL_BODY=$(cat <<EOF
          GitHub Actions 工作流已成功执行！
          执行时间: $(date +"%Y-%m-%d %H:%M:%S")
          运行环境: $(hostname)
          任务状态: 成功
          EOF
          )
          
          # 发送邮件（指定发件人，增加可读性）
          echo "$MAIL_BODY" | mail -s "$MAIL_SUBJECT" -r "action@github-actions-runner" "$MAIL_TO"
          
          # 查看发送日志（关键调试信息）
          sudo tail -n 20 /var/log/mail.log  # 输出邮件发送日志，确认是否成功发出
                
            