# 工作流名称：读取Windows服务器D盘目录
name: win服务器

# 触发条件：手动触发和main分支推送
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  win-up:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出代码到GitHub Actions运行器
      - name: 检出代码
        uses: actions/checkout@v3

      # 步骤2：先在Windows服务器创建目标目录
      - name: 创建D:\scripts目录
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: cmd /c "if not exist D:\scripts mkdir D:\scripts"
          debug: true

      # 步骤3：上传scripts文件夹到Windows服务器
      - name: 上传scripts文件夹到D:\scripts
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "scripts/"
          target: "D:\\"
          strip_components: 0
          rm: false
          debug: true

      # 步骤4：执行PowerShell脚本并保存输出结果
      - name: 执行脚本读取D盘目录（保存输出）
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          debug: true
          script: |
            powershell -ExecutionPolicy Bypass -File "D:\scripts\index.ps1" | Out-File -FilePath "D:\scripts\output.txt" -Encoding utf8
            echo "PowerShell输出已保存到D:\scripts\output.txt"

      # 步骤5：下载远程输出文件到GitHub Runner
      - name: 下载D盘扫描结果文件
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "D:/scripts/output.txt"  # 正斜杠避免YAML转义问题
          target: "./"  # 下载到Runner当前目录
          direction: download  # 关键：指定为下载（默认是上传）
          debug: true

      # 步骤6：发送包含扫描结果的邮件
      - name: 用Python+163授权码发送邮件（含扫描结果）
        env:
          SMTP_AUTH_CODE: ${{ secrets.SMTP_AUTH_CODE }}
          EMAIL: ${{ secrets.EMAIL }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        if: success()
        run: |
          python3 - <<EOF
          import smtplib
          import os
          import datetime
          import socket
          from email.mime.text import MIMEText
          from email.header import Header

          # 1. 读取环境变量配置
          smtp_server = "smtp.163.com"
          smtp_port = 465
          sender = os.getenv("EMAIL")
          password = os.getenv("SMTP_AUTH_CODE")
          receiver = os.getenv("TO_EMAIL")

          # 2. 获取动态信息（Python原生方法，避免语法冲突）
          current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
          hostname = socket.gethostname()

          # 3. 读取扫描结果文件（output.txt）
          try:
              with open("./output.txt", "r", encoding="utf-8") as f:
                  scan_result = f.read().strip()
              if not scan_result:
                  scan_result = "⚠️ 未获取到有效目录扫描结果"
          except FileNotFoundError:
              scan_result = "⚠️ 扫描结果文件下载失败（未找到output.txt）"
          except Exception as e:
              scan_result = f"⚠️ 读取扫描结果失败：{str(e)}"

          # 4. 构造邮件内容（含扫描结果）
          subject = "【GitHub Actions】Windows服务器D盘目录读取完成（含详情）"
          body = f"""
          尊敬的用户：
          以下是GitHub Actions工作流执行详情：
          - 执行时间：{current_time}
          - 运行环境：{hostname}
          - 任务类型：Windows服务器D盘目录扫描
          - 执行结果：成功（已完整读取D盘目录）

          【D盘目录扫描详细结果】
          {scan_result}

          操作说明：
          1. 如需验证目录完整性，可通过SSH登录Windows服务器查看D盘根目录
          2. 扫描结果文件已保存在服务器 D:\scripts\output.txt
          3. 此邮件为自动发送，请勿回复。
          """

          # 5. 邮件格式处理（确保中文无乱码）
          msg = MIMEText(body, "plain", "utf-8")
          msg["From"] = Header(sender, "utf-8")
          msg["To"] = Header(receiver, "utf-8")
          msg["Subject"] = Header(subject, "utf-8")

          # 6. 发送邮件
          try:
              server = smtplib.SMTP_SSL(smtp_server, smtp_port, timeout=10)
              print(f"✅ 成功连接163 SMTP服务器（{smtp_server}:{smtp_port}）")
              server.login(sender, password)
              print("✅ 163授权码认证成功")
              server.sendmail(sender, receiver, msg.as_string())
              print("✅ 邮件发送成功！请查收163邮箱")
              server.quit()
          except Exception as e:
              print(f"❌ 邮件发送失败：{str(e)}")
              raise  # 抛出错误便于排查
          EOF