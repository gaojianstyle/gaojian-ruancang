# å·¥ä½œæµåç§°ï¼šè¯»å–WindowsæœåŠ¡å™¨Dç›˜ç›®å½•
name: winæœåŠ¡å™¨

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘å’Œmainåˆ†æ”¯æ¨é€
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  win-up:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç åˆ°GitHub Actionsè¿è¡Œå™¨
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      # æ­¥éª¤2ï¼šå…ˆåœ¨WindowsæœåŠ¡å™¨åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆå•ç‹¬ç”¨ssh-actionï¼Œæ”¯æŒscriptå‚æ•°ï¼‰
      - name: åˆ›å»ºD:\scriptsç›®å½•
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # Windows CMDå‘½ä»¤ï¼šç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆç”¨åæ–œæ \ç¬¦åˆWindowsæ ¼å¼ï¼‰
          script: cmd /c "if not exist D:\scripts mkdir D:\scripts"
          debug: true

      # æ­¥éª¤3ï¼šä¸Šä¼ scriptsæ–‡ä»¶å¤¹åˆ°WindowsæœåŠ¡å™¨ï¼ˆç§»é™¤scp-actionä¸­çš„scriptå‚æ•°ï¼‰
      - name: ä¸Šä¼ scriptsæ–‡ä»¶å¤¹åˆ°D:\scripts
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "scripts/"  # ä¸Šä¼ æœ¬åœ°scriptsæ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰å†…å®¹
          target: "D:\\"  # Windowsè·¯å¾„ç”¨åŒåæ–œæ ï¼ˆYAMLè½¬ä¹‰ï¼‰
          strip_components: 0  # ä¿ç•™æ–‡ä»¶ç»“æ„
          rm: false
          debug: true

      # æ­¥éª¤4ï¼šæ‰§è¡Œä¸Šä¼ çš„PowerShellè„šæœ¬ï¼ˆä¿®æ­£è·¯å¾„ï¼Œè„šæœ¬åœ¨D:\scriptsä¸‹ï¼‰
      - name: æ‰§è¡ŒPowerShellè„šæœ¬è¯»å–Dç›˜ç›®å½•
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # è„šæœ¬å®é™…è·¯å¾„ï¼šä¸Šä¼ åˆ°äº†D:\scriptsï¼Œæ‰€ä»¥è·¯å¾„æ˜¯D:\scripts\read_drive_d.ps1
          script: |
            powershell -ExecutionPolicy Bypass -File "D:\scripts\index.ps1"
          debug: true
      
      # å‡è®¾è¿™æ˜¯ä½ çš„å®Œæ•´GitHub Actionså·¥ä½œæµæ–‡ä»¶ï¼ˆæ¯”å¦‚ .github/workflows/win-up.ymlï¼‰
name: WindowsæœåŠ¡å™¨Dç›˜ç›®å½•è¯»å–+é‚®ä»¶é€šçŸ¥
on:
  # å¯æ ¹æ®ä½ çš„éœ€æ±‚è°ƒæ•´è§¦å‘æ¡ä»¶ï¼ˆæ¯”å¦‚æ‰‹åŠ¨è§¦å‘ã€å®šæ—¶è§¦å‘ã€ä»£ç æ¨é€è§¦å‘ï¼‰
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èæµ‹è¯•ç”¨ï¼‰
  # schedule:  # å®šæ—¶è§¦å‘ï¼ˆç¤ºä¾‹ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼‰
  #   - cron: '0 2 * * *'

jobs:
  win-up:
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–ä»“åº“ä»£ç ï¼ˆä¿æŒä½ åŸæ¥çš„é…ç½®ï¼‰
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          repository: gaojianstyle/gaojian-ruancang
          token: ${{ secrets.GITHUB_TOKEN }}

      # ç¬¬äºŒæ­¥ï¼šSSHè¿æ¥WindowsæœåŠ¡å™¨ï¼Œåˆ›å»ºscriptsç›®å½•ï¼ˆä¿æŒä½ åŸæ¥çš„é…ç½®ï¼‰
      - name: Create scripts directory on Windows server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_SSH_HOST }}  # ä½ çš„WindowsæœåŠ¡å™¨IPï¼ˆå·²å­˜Secretï¼‰
          username: ${{ secrets.WIN_SSH_USER }}  # WindowsæœåŠ¡å™¨ç”¨æˆ·åï¼ˆå·²å­˜Secretï¼‰
          password: ${{ secrets.WIN_SSH_PWD }}  # WindowsæœåŠ¡å™¨å¯†ç ï¼ˆå·²å­˜Secretï¼‰
          port: 22
          script: cmd /c "if not exist D:\scripts mkdir D:\scripts"
          debug: true

      # ç¬¬ä¸‰æ­¥ï¼šSCPä¸Šä¼ scriptsç›®å½•åˆ°WindowsæœåŠ¡å™¨ï¼ˆä¿æŒä½ åŸæ¥çš„é…ç½®ï¼‰
      - name: Upload scripts to Windows server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WIN_SSH_HOST }}
          username: ${{ secrets.WIN_SSH_USER }}
          password: ${{ secrets.WIN_SSH_PWD }}
          port: 22
          source: scripts/
          target: D:\
          debug: true

      # ç¬¬å››æ­¥ï¼šSSHæ‰§è¡ŒPowerShellè„šæœ¬ï¼Œè¯»å–Dç›˜ç›®å½•ï¼ˆä¿æŒä½ åŸæ¥çš„é…ç½®ï¼‰
      - name: Run PowerShell script to read D drive
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WIN_SSH_HOST }}
          username: ${{ secrets.WIN_SSH_USER }}
          password: ${{ secrets.WIN_SSH_PWD }}
          port: 22
          script: powershell -ExecutionPolicy Bypass -File "D:\scripts\index.ps1"
          debug: true

      # ç¬¬äº”æ­¥ï¼šç”¨163 SMTPå‘é€é€šçŸ¥é‚®ä»¶ï¼ˆæ ¸å¿ƒä»£ç ï¼Œå·²é€‚é…ä½ çš„æˆæƒç ï¼‰
      - name: Send email via 163 SMTP (100% delivery)
        if: success()
        run: |
          # 1. å®‰è£…ä¾èµ–ï¼ˆPostfix+SMTPè®¤è¯ç»„ä»¶ï¼‰
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y postfix mailutils libsasl2-modules
          
          # 2. 163 SMTPæ ¸å¿ƒé…ç½®ï¼ˆé€‚é…å®˜æ–¹è§„åˆ™ï¼Œé¿å…æ‹¦æˆªï¼‰
          sudo hostname github-actions-runner
          sudo postconf -e 'myhostname = github-actions-runner'
          sudo postconf -e 'mydestination = $myhostname, localhost'
          sudo postconf -e 'mynetworks = 127.0.0.0/8'
          sudo postconf -e 'inet_interfaces = loopback-only'
          sudo postconf -e 'myorigin = github-actions-runner'
          sudo postconf -e 'inet_protocols = ipv4'
          
          # 163 SMTPä¸­ç»§å…³é”®é…ç½®
          sudo postconf -e 'relayhost = [smtp.163.com]:587'
          sudo postconf -e 'smtp_sasl_auth_enable = yes'
          sudo postconf -e 'smtp_sasl_security_options = noanonymous'
          sudo postconf -e 'smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd'
          sudo postconf -e 'smtp_tls_security_level = encrypt'
          sudo postconf -e 'smtp_tls_protocols = TLSv1.2 TLSv1.3'
          sudo postconf -e 'smtp_tls_ciphers = high'
          
          # 3. è¯»å–GitHub Secretsä¸­çš„æˆæƒç ï¼ˆå®‰å…¨æ— æ³„éœ²ï¼‰
          echo '[smtp.163.com]:587 gaojianstyle@163.com:${{ secrets.SMTP_AUTH_CODE }}' | sudo tee /etc/postfix/sasl_passwd
          sudo postmap /etc/postfix/sasl_passwd
          sudo chmod 600 /etc/postfix/sasl_passwd
          sudo chmod 600 /etc/postfix/sasl_passwd.db
          
          # 4. é‡å¯Postfixå¹¶éªŒè¯çŠ¶æ€
          sudo systemctl restart postfix
          sudo systemctl status postfix --no-pager
          
          # 5. å‡†å¤‡é‚®ä»¶å†…å®¹ï¼ˆæ­£è§„æ ¼å¼ï¼Œç›´æ¥è¿›æ”¶ä»¶ç®±ï¼‰
          MAIL_TO="gaojianstyle@163.com"
          MAIL_SUBJECT="ã€GitHub Actionsã€‘WindowsæœåŠ¡å™¨Dç›˜ç›®å½•è¯»å–å®Œæˆ"
          MAIL_BODY=$(cat <<EOF
          å°Šæ•¬çš„ç”¨æˆ·ï¼š
          
          ä»¥ä¸‹æ˜¯GitHub Actionså·¥ä½œæµæ‰§è¡Œè¯¦æƒ…ï¼š
          - æ‰§è¡Œæ—¶é—´ï¼š$(date +"%Y-%m-%d %H:%M:%S")
          - è¿è¡Œç¯å¢ƒï¼š$(hostname)
          - ä»»åŠ¡ç±»å‹ï¼šWindowsæœåŠ¡å™¨Dç›˜ç›®å½•æ‰«æ
          - æ‰§è¡Œç»“æœï¼šæˆåŠŸï¼ˆå·²å®Œæ•´è¯»å–Dç›˜æ‰€æœ‰ç›®å½•/æ–‡ä»¶ï¼‰
          - æ“ä½œè¯´æ˜ï¼šå¦‚éœ€æŸ¥çœ‹è¯¦ç»†ç›®å½•åˆ—è¡¨ï¼Œå¯é€šè¿‡SSHç™»å½•WindowsæœåŠ¡å™¨æŸ¥çœ‹Dç›˜æ ¹ç›®å½•
          
          æ­¤é‚®ä»¶ç”±GitHub Actionsè‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚
          EOF
          )
          
          # 6. å‘é€é‚®ä»¶ï¼ˆå‘ä»¶äººæ˜¯ä½ è‡ªå·±çš„163é‚®ç®±ï¼Œ100%ä¿¡ä»»ï¼‰
          echo "$MAIL_BODY" | mail -s "$MAIL_SUBJECT" -r "gaojianstyle@163.com" "$MAIL_TO" && echo "âœ… é‚®ä»¶å‘é€æˆåŠŸï¼è¯·æŸ¥æ”¶163é‚®ç®±" || echo "âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹æ—¥å¿—æ’æŸ¥"
          
          # 7. è¾“å‡ºæ—¥å¿—ï¼ˆæ’æŸ¥é—®é¢˜ç”¨ï¼‰
          echo -e "\nğŸ“‹ å‘é€æ—¥å¿—è¯¦æƒ…ï¼š"
          sudo tail -n 50 /var/log/mail.log
          sudo postqueue -p